{% comment %}
==============================================================================
BASE TEMPLATE - ShopCredit Dashboard Layout
==============================================================================
This is the main layout template that all authenticated pages extend.

Features:
- Sidebar navigation (role-based)
- Top navbar with user dropdown
- Content area
- Bootstrap 5 + Chart.js included locally

Note: For offline operation, all CSS/JS are served from static files.
==============================================================================
{% endcomment %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ShopCredit - Intelligent Digital Udhaar System">
    <title>{% block title %}ShopCredit{% endblock %}</title>

    <!-- Local CSS Files (Offline-First) with CDN Fallbacks -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}"
        onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css';">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=2.1">

    <!-- Bootstrap Icons (inline SVG sprites for offline) -->
    <style>
        /* Inline icon styles for offline operation */
        .bi {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.125em;
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- =========================================
         SIDEBAR NAVIGATION
         ========================================= -->
    <nav class="sidebar" id="sidebar">
        <!-- Brand Logo -->
        <div class="sidebar-brand">
            <img src="{% static 'images/logo.png' %}" alt="ShopCredit" class="brand-logo">
            <div class="brand-text">
                <h2>ShopCredit</h2>
                <small>Intelligent Udhaar System</small>
            </div>
        </div>

        <!-- Navigation Menu -->
        <ul class="sidebar-menu">
            <!-- Dashboard -->
            <li>
                <a href="{% url 'accounts:dashboard' %}"
                    class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    <span class="menu-icon">üè†</span>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>

            {% if user.role == 'shop_owner' %}
            <!-- Shop Owner Menu -->
            <li class="sidebar-section">Shopping</li>
            <li>
                <a href="{% url 'core:product_list' %}" class="{% if 'product' in request.path %}active{% endif %}">
                    <span class="menu-icon">üì¶</span>
                    <span class="menu-text">Products</span>
                </a>
            </li>
            <li>
                <a href="{% url 'core:order_list' %}" class="{% if 'order' in request.path %}active{% endif %}">
                    <span class="menu-icon">üõí</span>
                    <span class="menu-text">My Orders</span>
                </a>
            </li>
            <li>
                <a href="{% url 'core:emi_list' %}" class="{% if 'emi' in request.path %}active{% endif %}">
                    <span class="menu-icon">üìÖ</span>
                    <span class="menu-text">EMI Payments</span>
                </a>
            </li>

            {% elif user.role == 'wholesaler' %}
            <!-- Wholesaler Menu -->
            <li class="sidebar-section">Inventory</li>
            <li>
                <a href="{% url 'core:product_list' %}" class="{% if 'product' in request.path %}active{% endif %}">
                    <span class="menu-icon">üì¶</span>
                    <span class="menu-text">My Products</span>
                </a>
            </li>
            <li>
                <a href="{% url 'core:product_add' %}">
                    <span class="menu-icon">‚ûï</span>
                    <span class="menu-text">Add Product</span>
                </a>
            </li>

            <li class="sidebar-section">Credit Management</li>
            <li>
                <a href="{% url 'core:order_list' %}" class="{% if 'order' in request.path %}active{% endif %}">
                    <span class="menu-icon">üìã</span>
                    <span class="menu-text">Orders</span>
                </a>
            </li>
            <li>
                <a href="{% url 'core:transaction_list' %}"
                    class="{% if 'transaction' in request.path %}active{% endif %}">
                    <span class="menu-icon">üí∞</span>
                    <span class="menu-text">Transactions</span>
                </a>
            </li>

            {% elif user.role == 'admin' %}
            <!-- Admin Menu -->
            <li class="sidebar-section">Administration</li>
            <li>
                <a href="/admin/" target="_blank">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <span class="menu-text">Django Admin</span>
                </a>
            </li>
            <li>
                <a href="{% url 'core:product_list' %}">
                    <span class="menu-icon">üì¶</span>
                    <span class="menu-text">All Products</span>
                </a>
            </li>
            <li>
                <a href="{% url 'core:order_list' %}">
                    <span class="menu-icon">üìã</span>
                    <span class="menu-text">All Orders</span>
                </a>
            </li>
            {% endif %}

            <!-- Analytics Section (All Roles) -->
            <li class="sidebar-section">Analytics</li>
            <li>
                <a href="{% url 'analytics:dashboard' %}" class="{% if 'analytics' in request.path %}active{% endif %}">
                    <span class="menu-icon">üìä</span>
                    <span class="menu-text">Analytics</span>
                </a>
            </li>

            {% if user.role != 'shop_owner' %}
            <li>
                <a href="{% url 'analytics:risk_overview' %}">
                    <span class="menu-icon">‚ö†Ô∏è</span>
                    <span class="menu-text">Risk Assessment</span>
                </a>
            </li>
            {% endif %}

            <!-- Reports Section -->
            <li class="sidebar-section">Reports</li>
            <li>
                <a href="{% url 'reports:credit_history' %}">
                    <span class="menu-icon">üìÑ</span>
                    <span class="menu-text">Credit History</span>
                </a>
            </li>

            <!-- Account Section -->
            <li class="sidebar-section">Account</li>
            <li>
                <a href="{% url 'accounts:profile' %}">
                    <span class="menu-icon">üë§</span>
                    <span class="menu-text">Profile</span>
                </a>
            </li>
            <li>
                <a href="{% url 'accounts:logout' %}">
                    <span class="menu-icon">üö™</span>
                    <span class="menu-text">Logout</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- =========================================
         MAIN CONTENT AREA
         ========================================= -->
    <main class="main-content">
        <!-- Top Navbar -->
        <div class="top-navbar">
            <div class="d-flex align-items-center gap-3">
                <button class="btn-menu-toggle" id="menuToggle" onclick="toggleSidebar()" title="Toggle Menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1>{% block page_title %}Dashboard{% endblock %}</h1>
            </div>

            <div class="user-actions">
                <div class="user-info">
                    <div class="user-avatar">{{ user.username|slice:":1"|upper }}</div>
                    <div class="user-details d-none d-md-block">
                        <span class="user-name">{{ user.username }}</span>
                        <span class="user-role">{{ user.get_role_display }}</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <a href="{% url 'accounts:profile' %}" class="btn-action btn-profile" title="My Profile">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </a>
                    <a href="{% url 'accounts:logout' %}" class="btn-action btn-logout" title="Logout">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% if messages %}
        <div class="messages-container mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Page Content -->
        <div class="content-wrapper fade-in">
            {% block content %}
            <!-- Page content goes here -->
            {% endblock %}
        </div>
    </main>

    <!-- =========================================
         JAVASCRIPT
         ========================================= -->
    <!-- Local JS Files (Offline-First) with CDN Fallbacks -->
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script>if (typeof bootstrap === 'undefined') document.write('<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"><\/script>');</script>
    <script src="{% static 'js/chart.min.js' %}"></script>
    <script>if (typeof Chart === 'undefined') document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>');</script>

    <script>
        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');

            // Save state to localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }

        // Restore sidebar state on page load
        document.addEventListener('DOMContentLoaded', function () {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
                document.querySelector('.main-content').classList.add('sidebar-collapsed');
            }
        });

        // Format currency values
        function formatCurrency(amount) {
            return '‚Çπ' + parseFloat(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Format dates
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>